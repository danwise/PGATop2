<!DOCTYPE html> 
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PGA Top2 - Player Matchup</title>
	<link rel="stylesheet"  href="../jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.css">
    <link rel="stylesheet" href="../jquery.mobile-1.4.2/jqm-demos.css">
	<link rel="shortcut icon" href="../favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,700">
	<script src='http://code.jquery.com/jquery-1.11.0.min.js'></script>    
	<script src="../jquery.mobile-1.4.2/index.js"></script>
	<script src='http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js'></script>
    <script src="../Scripts/jquery.cookie.js"></script>
    <script type="text/javascript">
        $(window).load(function () {
            $.mobile.loading('show');
        });

    </script>
</head> 
<body> 
<div data-role="page" id="pMatchup" data-close-btn="right" class="jqm-demos">
<script src="../Scripts/GetURLParameters.js"></script>
<script src="../Scripts/RefreshXML_MatchupsOnly.js"></script>
<script type="text/javascript" src="../scripts/autoNumeric.js"></script>
<script type="text/javascript">
    jQuery(function ($) {
        $('.auto').autoNumeric('init');
    });
</script>
<script language = 'javascript'>
     $("#pMatchup").on('pageinit', function () {
               // debugger;
        var urlParameters = getUrlVarsPage('pMatchup');
        var PlayerMatchupId;
        var GolfTeamId;
        if (urlParameters != "") {
            if (urlParameters.PlayerMatchupId != null) {
                PlayerMatchupId = urlParameters.PlayerMatchupId
            }

            if (urlParameters.GolfTeamId != null) {
                GolfTeamId = urlParameters.GolfTeamId
            }  
        }

//        $("#accept").css("visibility", "hidden").css("display", "none");
//        $("#reject").css("visibility", "hidden").css("display", "none");
//        $("#propose").css("visibility", "hidden");
        //        $("#rebut").css("visibility", "hidden").css("display", "none");

        loadMatchup(PlayerMatchupId, GolfTeamId);
        
    });


    $("#betAmount").change(function () {
        //debugger;
        var slider_value = $("#slider").val();
        //        $('#UnderdogAmount').val(slider_value * $('#UnderdogAmountPerDollar').text());
        //        $('#FavoriteAmount').val(slider_value * $('#FavoriteAmountPerDollar').text());
        $('#FavoriteAmount').autoNumeric('set', slider_value * $('#FavoriteAmountPerDollar').text());
        $('#UnderdogAmount').autoNumeric('set', slider_value * $('#UnderdogAmountPerDollar').text());
        if ($('#NotProposed').text() != "true") {
            if (parseFloat(slider_value) != parseFloat($('#holdBetAmount').text())) {
                $("#accept").addClass('ui-btn ui-state-disabled');
                $("#rebut").removeClass('ui-btn ui-state-disabled');
                }
                else {
                    $("#accept").removeClass('ui-btn ui-state-disabled');
                    $("#rebut").addClass('ui-btn ui-state-disabled');
                }
        }
    });

    
//    function loadMatchup(matchupId,golfTeamId) {
//          //    debugger;
//        var xmlLoc = "xml/" + $.cookie("GolfEventId") + "_" + golfTeamId + "_PlayerMatchups.xml";
        //var xmlLoc = "xml/3af41d9f-05e2-e211-ad2d-3ebb89d5579f_PlayerMatchups.xml";

//        $.ajax(
//            {
//                beforeSend: function () { $.mobile.showPageLoadingMsg("e", "Loading Matchups..."); }, //Show spinner
//                complete: function () { $.mobile.hidePageLoadingMsg() }, //Hide spinner
//                type: "GET",
//                datatype: "xml",
//                url: xmlLoc,
//                async: false,
//                cache: false,
//                data: {},
//                success: function (xml) { xmlParser(xml, matchupId, golfTeamId); },
//                error: function (XMLHttpRequest, textStatus, errorThrown) {
//                    alert(errorThrown);
//                }
//            });

            function loadMatchup(matchupId,golfTeamId) 
            {
            //          debugger;
                $.ajax(
                        {
                            beforeSend: function () { $.mobile.loading("show"); }, //Show spinner
                            complete: function () { $.mobile.loading("hide"); }, //Hide spinner
                            type: "POST",
                            datatype: "xml",
                            url: "../Golf.EventDraft.asmx/PlayerMatchup",
                            data: { GolfTeamId: golfTeamId, SideBetTeamsId: matchupId},
                            success: function (xml) { xmlParser(xml, matchupId, golfTeamId); },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                alert(errorThrown);
                            }
                        });
           }

            function xmlParser(xml, matchupId, golfTeamId) {
                $(xml).find("PlayerMatchup").filter(function () {
                    return $(this).find('PlayerMatchupId').first().text().toUpperCase() == matchupId.toUpperCase();
                }).each(function (index) {
//                    $("#MatchupTitle").text($(this).find('PlayerMatchupTitle').first().text());
                    $('#UnderdogTeam').text($(this).find('UnderdogGolfTeam').first().text());
                    $('#FavoriteTeam').text($(this).find('FavoriteGolfTeam').first().text());
                    $('#FavoriteAmountPerDollar').text($(this).find('FavoriteAmountPerDollar').first().text());
                    $('#UnderdogAmountPerDollar').text($(this).find('UnderdogAmountPerDollar').first().text());
                    $('#holdBetAmount').text($(this).find('BetAmount').first().text());
                    $('#lblUnderdog').text($(this).find('UnderdogGolfTeam').first().text());
                    $('#lblFavorite').text($(this).find('FavoriteGolfTeam').first().text());
                    
                    
//                                        debugger;
                    //New Bet - Underdog
                    if ($(this).find('UnderdogGolfTeamId').first().text().toUpperCase() == golfTeamId.toUpperCase() && ($(this).find('FavoriteAccepted').first().text() == "false" || $(this).find('BetStatus').first().text() == "Declined")) {
                        $('#NotProposed').text("true");
//                        $("#accept").css("visibility", "hidden");
//                        $("#reject").css("visibility", "hidden");
//                        $("#rebut").css("visibility", "hidden");
                        if ($(this).find('BetStatus').first().text() == "Active" && $(this).find('FavoriteAccepted').first().text() == "false") {
                            $("#propose").attr('disabled', false).removeClass('ui-btn ui-state-disabled');
                        }
//                        $("#pendingBetAmount").css("visibility", "hidden");
                        $('#slider').val($(this).find('BetAmount').first().text());
                        $('#slider').slider('refresh');
                        $('#divBetStakes').css("visibility", "hidden");
                        $('#UnderdogAmount').text($(this).find('UnderdogGolfTeam').first().text() + ' $' + $(this).find('BetAmount').first().text() * $('#UnderdogAmountPerDollar').text());
                        $('#FavoriteAmount').text($(this).find('FavoriteGolfTeam').first().text() + ' $' + $(this).find('BetAmount').first().text() * $('#FavoriteAmountPerDollar').text());
                        
                    }

                    //New Bet - Favorite
                    if ($(this).find('FavoriteGolfTeamId').first().text().toUpperCase() == golfTeamId.toUpperCase() && ($(this).find('UnderdogAccepted').first().text() == "false" || $(this).find('BetStatus').first().text() == "Declined")) {
                        $('#NotProposed').text("true");
//                        $("#accept").css("visibility", "hidden");
//                        $("#reject").css("visibility", "hidden");
//                        $("#rebut").css("visibility", "hidden");
                        if ($(this).find('BetStatus').first().text() == "Active" && $(this).find('UnderdogAccepted').first().text() == "false")
                        {
                            $("#propose").attr('disabled', false).removeClass('ui-btn ui-state-disabled');
                        }
//                        $("#pendingBetAmount").css("visibility", "hidden");
                        $('#slider').val($(this).find('BetAmount').first().text());
                        $('#slider').slider('refresh');
                        $('#divBetStakes').css("visibility", "hidden");


                        $('#UnderdogAmount').text($(this).find('UnderdogGolfTeam').first().text() + ' $' + $(this).find('BetAmount').first().text() * $('#UnderdogAmountPerDollar').text());
                        $('#FavoriteAmount').text($(this).find('FavoriteGolfTeam').first().text() + ' $' + $(this).find('BetAmount').first().text() * $('#FavoriteAmountPerDollar').text());
                    }

                    //Bet Proposed Not Accepted - Underdog
                    if ($(this).find('UnderdogGolfTeamId').first().text().toUpperCase() == golfTeamId.toUpperCase() && $(this).find('FavoriteAccepted').first().text() == "true" && $(this).find('UnderdogAccepted').first().text() == "false") {
                        $('#NotProposed').text("false");
//                        $("#propose").css("visibility", "hidden");
                        //                        $("#rebut").css("visibility", "hidden");
                        $("#reject").button().attr('disabled', false).removeClass('ui-btn ui-state-disabled');
                        $("#accept").button().attr('disabled', false).removeClass('ui-btn ui-state-disabled');
                        $('#slider').val($(this).find('BetAmount').first().text());
                        $('#slider').slider('refresh');
                        populateBet($(this));
                        $("#dProposals").css("visibility", "visible").css("display", "inline");
                        buildProposals($(this));
                        
//                        $("#pendingBetAmount").text("Proposed Bet Baseline $" + $(this).find('BetAmount').first().text());
                    }

                    //Bet Proposed Not Accepted - Favorite
                    if ($(this).find('FavoriteGolfTeamId').first().text().toUpperCase() == golfTeamId.toUpperCase() && $(this).find('UnderdogAccepted').first().text() == "true" && $(this).find('FavoriteAccepted').first().text() == "false") {
                        $('#NotProposed').text("false");
//                        $("#propose").css("visibility", "hidden");
                        //                        $("#rebut").css("visibility", "hidden");
                        $("#reject").button().attr('disabled', false).removeClass('ui-btn ui-state-disabled');
                        $("#accept").button().attr('disabled', false).removeClass('ui-btn ui-state-disabled');
                        $('#slider').val($(this).find('BetAmount').first().text());
                        $('#slider').slider('refresh');
                        populateBet($(this));
                        $("#dProposals").css("visibility", "visible").css("display", "inline");
                        buildProposals($(this));
//                        $("#pendingBetAmount").css("visibility", "visible").css("display", "inline");
//                        $("#pendingBetAmount").text("Proposed Bet Baseline $" + $(this).find('BetAmount').first().text());
                    }


                    //                    //Bet Accepted- Favorite
                    //                    if ($(this).find('UnderdogAccepted').first().text() == "true" && $(this).find('FavoriteAccepted').first().text() == "true") {
                    //                        $("#pendingBetAmount").text("Bet Baseline $" + $(this).find('BetAmount').first().text());
                    //                        $('#betStakes').text("This bet has been accepted");
                    //                        $('#slider').slider('refresh');
                    //                        $('#betAmount').css("visibility", "hidden");
                    //                        $("#accept").css("visibility", "hidden");
                    //                        $("#reject").css("visibility", "hidden");
                    //                        $("#propose").css("visibility", "hidden");
                    //                    }

                    return false;
                });
            }

            function buildProposals(xml) {

                $("#dProposals").append($('<div/>',
                    {
                        //'data-role': 'list-divider',
                        'data-role': 'collapsible',
                        'data-theme': 'c',
                        'data-collapsed-icon': 'arrow-r',
                        'data-expanded-icon': 'arrow-d',
                        'data-collapsed': 'true',
                        'data-mini': 'true'
                    })
                    .append($('<h3/>',
                    {
                        'text': "Proposal History"
                    })).css("font-size", "10px")
                    .append($('<ul/>',
                    {
                        'id': "ProposalHistory",
                        'data-role': 'listview',
                        'data-inset': 'true'
                    })));

//                $("#dProposals").append
//                                (
//                                    $('<h3/>',
//                                    {
//                                        'text': "Proposal History"
//                                    }).css("font-size", "12px")
//                                ).append($('<ul/>',
//                                {
//                                    'id': "ProposalHistory",
//                                    'data-role': 'listview',
//                                    'data-inset': 'true'
//                                }));

                    $(xml).find("PlayerMatchupProposal").each
                            (
                                        function () {
                                            $("#ProposalHistory")
                                            .append
                                            (
                                                $('<li/>', {})
                                                .append
                                                (
                                                    $('<p/>',
                                                    {
                                                        'text': $(this).find("Name").text(),
                                                        'class': 'smallHeader'
                                                    }).css("font-size", "10px")
                                                )
                                            );
                                        }
                           )
                    $('.ui-page-active .ui-listview').listview('refresh');
                    $('.ui-page-active :jqmData(role=content)').trigger('create');
                
            }
            

        function populateBet(xml) {
           // debugger;
            //$('#divBetStakes').css("visibility", "hidden");
            $('#ulBetStakes').append($('<li/>', {})
                        .append($('<h3/>',
                        {
                            'text': $(xml).find("UnderdogGolfer").first().text() + " " + ($(xml).find("UnderdogOdds").text() > 0 ? "(+" + $(xml).find("UnderdogOdds").text() + ")" : "(" + ($(xml).find("UnderdogOdds").text()=="0"?"Even":$(xml).find("UnderdogOdds").text()) + ")")
                        }))
                        .append($('<p/>',
                        {
                            'text': $(xml).find("UnderdogGolfTeam").text() + " $" + $(xml).find("UnderdogAmount").text()
                        })));

                      $('#ulBetStakes').append($('<li/>', {})
                                .append($('<h3/>',
                                {
                                    'text': $(xml).find("FavoriteGolfer").first().text() + " " + ($(xml).find("FavoriteOdds").text() > 0 ? "(+" + $(xml).find("FavoriteOdds").text() + ")" : "(" + ($(xml).find("FavoriteOdds").text() == "0"?"Even":$(xml).find("FavoriteOdds").text()) + ")")
                                }))
                                .append($('<p/>',
                                {
                                    'text': $(xml).find("FavoriteGolfTeam").text() + " $" + $(xml).find("FavoriteAmount").text()
                                })));

                        $('#ulBetStakes').listview('refresh'); 
        }

        function acceptBet() 
        {
            var urlParameters = getUrlVarsPage('pMatchup');
            var matchupId;
            var golfTeamId;
            if (urlParameters != "") {
                if (urlParameters.PlayerMatchupId != null) {
                    matchupId = urlParameters.PlayerMatchupId
                }

                if (urlParameters.GolfTeamId != null) {
                    golfTeamId = urlParameters.GolfTeamId
                }
            }

//            debugger;
            $.ajax(
                {
                    beforeSend: function () { $.mobile.showPageLoadingMsg("e", "Accepting Bet..."); }, //Show spinner
                    complete: function () { $.mobile.hidePageLoadingMsg() }, //Hide spinner
                    type: "POST",
                    datatype: "xml",
                    async: false,
                    cache: false,
                    url: "../Golf.EventDraft.asmx/AcceptBet",
                    data: { PlayerMatchupId: matchupId, GolfTeamId: golfTeamId },
                    success: function (xml) { $.mobile.hidePageLoadingMsg(); Success(); },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(errorThrown);
                    }
                });
        }

        function counterOffer() 
        {
            var urlParameters = getUrlVarsPage('pMatchup');
            var matchupId;
            var golfTeamId;
            if (urlParameters != "") {
                if (urlParameters.PlayerMatchupId != null) {
                    matchupId = urlParameters.PlayerMatchupId
                }

                if (urlParameters.GolfTeamId != null) {
                    golfTeamId = urlParameters.GolfTeamId
                }
            }
            var amount = $('#slider').val();
//            debugger;
            $.ajax(
                    {
                        beforeSend: function () { $.mobile.showPageLoadingMsg("e", "Making Counter Offer..."); }, //Show spinner
                        complete: function () { $.mobile.hidePageLoadingMsg() }, //Hide spinner
                        type: "POST",
                        datatype: "xml",
                        async: false,
                        cache: false,
                        url: "../Golf.EventDraft.asmx/CounterOfferBet",
                        data: { PlayerMatchupId: matchupId, GolfTeamId: golfTeamId, Amount: amount },
                        success: function (xml) { $.mobile.hidePageLoadingMsg(); Success(); },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            alert(errorThrown);
                        }
                    });
        }

        function declineBet() 
        {
                var urlParameters = getUrlVarsPage('pMatchup');
                var matchupId;
                var golfTeamId;
                if (urlParameters != "") {
                    if (urlParameters.PlayerMatchupId != null) {
                        matchupId = urlParameters.PlayerMatchupId
                    }

                    if (urlParameters.GolfTeamId != null) {
                        golfTeamId = urlParameters.GolfTeamId
                    }
                }
            $.ajax(
                {
                    beforeSend: function () { $.mobile.showPageLoadingMsg("e", "Declining Bet..."); }, //Show spinner
                    complete: function () { $.mobile.hidePageLoadingMsg() }, //Hide spinner
                    type: "POST",
                    datatype: "xml",
                    async: false,
                    cache: false,
                    url: "../Golf.EventDraft.asmx/DeclineBet",
                    data: { PlayerMatchupId: matchupId, GolfTeamId: golfTeamId },
                    success: function (xml) { $.mobile.hidePageLoadingMsg(); Success(); },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert(errorThrown);
                    }
                });
        }

        function proposeBet() 
        {
            //debugger;
            var urlParameters = getUrlVarsPage('pMatchup');
            var matchupId;
            var golfTeamId;
            if (urlParameters != "") {
                if (urlParameters.PlayerMatchupId != null) {
                    matchupId = urlParameters.PlayerMatchupId
                }

                if (urlParameters.GolfTeamId != null) {
                    golfTeamId = urlParameters.GolfTeamId
                }
            }
            var amount = $('#slider').val() ;
            $.ajax(
            {
                beforeSend: function () { $.mobile.showPageLoadingMsg("e", "Accepting Bet..."); }, //Show spinner
                complete: function () { $.mobile.hidePageLoadingMsg() }, //Hide spinner
                type: "POST",
                datatype: "xml",
                async: false,
                cache: false,
                url: "../Golf.EventDraft.asmx/ProposeBet",
                data: { PlayerMatchupId: matchupId, GolfTeamId: golfTeamId, Amount:amount },
                success: function (xml) { $.mobile.hidePageLoadingMsg(); Success(); },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert(errorThrown);
                }
            });
        }

        function Success() {
            refreshXml();
            $('.ui-dialog').dialog('close');
            location.reload();
        }

        
    
</script>

    <div data-role="header" data-theme="d" >
        <h3>Player Matchup</h3>
    </div>

    <div data-role="content" data-theme="c" >
            <div data-role="fieldcontain" id="divBetStakes">
                <ul data-role="listview" id="ulBetStakes"></ul>
            </div>
            <div id='dProposals' style="visibility:hidden;display:none" data-role='collapsible-set'></div>
            <div data-role="fieldcontain" id="betAmount">
                <label for="slider">Baseline $</label>
                <input type="range" name="slider" id="slider"  min="0" max="100"  data-popup-enabled="true" data-show-value="true"></input>
            </div>
            <div id="divBetProposed" class="ui-grid-a">
                <div class="ui-block-a">
                    <label for="UnderdogAmount" id="lblUnderdog">Underdog</label>
                    <input id="UnderdogAmount" type="text" class="auto" data-a-sign="$ " readonly/>
                </div>
                 <div class="ui-block-b">
                    <label for="FavoriteAmount" id="lblFavorite">Favorite</label>
                    <input id="FavoriteAmount" type="text" class="auto" data-a-sign="$ " readonly/>
                </div>
            </div>
            <div>
                <a href='javascript:proposeBet()' data-role="button" data-inline="true" id="propose" class="ui-btn ui-state-disabled">Propose Bet</a>
                <a href='javascript:declineBet()' data-role="button" data-inline="true" id="reject" class="ui-btn ui-state-disabled">Reject Bet</a>
            </div>
            <div>
                <a href='javascript:acceptBet()' data-role="button" data-inline="true" id="accept" class="ui-btn ui-state-disabled">Accept Bet</a>
                <a href='javascript:counterOffer()' data-role="button" data-inline="true" id="rebut" class="ui-btn ui-state-disabled">Counter Offer</a>
            </div>
            <input type="hidden" id="UnderdogAmountPerDollar"/>
            <input type="hidden" id="FavoriteAmountPerDollar"/>
            <input type="hidden" id="holdBetAmount"/>
            <input type="hidden" id="UnderdogTeam"/>
            <input type="hidden" id="FavoriteTeam"/>
            <input type="hidden" id="NotProposed"/>
        </div>
	</div>
</body>
</html>
